{% extends "admin/base.html" %}

{% block title %}{{ 'Edit' if post else 'New' }} Blog Post - Admin{% endblock %}
{% block page_title %}✍️ {{ 'Edit' if post else 'New' }} Post{% endblock %}

{% block extra_head %}
<!-- Quill Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
    .ql-editor {
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
    }
    .ql-container {
        font-size: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <h1>{{ 'Edit' if post else 'New' }} Blog Post</h1>
    
    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    
    <form method="post" action="{% if post %}/admin/blog/{{ post.id }}/edit{% else %}/admin/blog/new{% endif %}" enctype="multipart/form-data" class="admin-form">
        <div class="form-group">
            <label for="title">Title *</label>
            <input type="text" id="title" name="title" value="{{ post.title if post else '' }}" required>
        </div>
        
        <div class="form-group">
            <label for="slug">Slug *</label>
            <input type="text" id="slug" name="slug" value="{{ post.slug if post else '' }}" required pattern="[a-z0-9-]+">
            <small>URL-friendly identifier (lowercase, hyphens only)</small>
        </div>
        
        <div class="form-group">
            <label for="excerpt">Excerpt (max 250 characters) *</label>
            <textarea id="excerpt" name="excerpt" rows="3" maxlength="250" required>{{ post.excerpt if post else '' }}</textarea>
            <small>Brief summary shown on blog listings (max 250 characters)</small>
        </div>
        
        <div class="form-group">
            <label for="content">Content *</label>
            <div id="editor-container" style="background: white;"></div>
            <textarea id="content" name="content" style="display:none;" required>{{ post.content if post else '' }}</textarea>
            <small>Rich text editor with formatting options</small>
        </div>
        
        <div class="form-group">
            <label for="tags">Tags (comma-separated)</label>
            <input type="text" id="tags" name="tags" value="{{ post.tags if post else '' }}">
            <small>Example: Python,Web Development,Tutorial</small>
        </div>
        
        <div class="form-group">
            <label for="cover_image">Cover Image</label>
            {% if post and post.cover_image %}
            <div class="current-image">
                <img src="{{ post.cover_image }}" alt="Current cover" style="max-width: 200px; margin-bottom: 10px;">
                <p><small>Current cover image</small></p>
            </div>
            {% endif %}
            <input type="file" id="cover_image" name="cover_image" accept="image/*">
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="is_published" name="is_published" value="1" {% if post and post.is_published %}checked{% endif %}>
                <span>Publish this post (uncheck to save as draft)</span>
            </label>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">{{ 'Update' if post else 'Create' }} Post</button>
            <a href="/admin/blog" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
// Initialize Quill editor
var quill = new Quill('#editor-container', {
    theme: 'snow',
    modules: {
        toolbar: [
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'font': [] }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'script': 'sub'}, { 'script': 'super' }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'indent': '-1'}, { 'indent': '+1' }],
            [{ 'align': [] }],
            ['blockquote', 'code-block'],
            ['link', 'image', 'video'],
            ['clean']
        ]
    },
    placeholder: 'Write your blog post content here...'
});

// Load existing content
var contentTextarea = document.getElementById('content');
if (contentTextarea.value) {
    quill.root.innerHTML = contentTextarea.value;
}

// Auto-generate slug from title
document.getElementById('title').addEventListener('input', function(e) {
    var slug = e.target.value
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
    document.getElementById('slug').value = slug;
});

// Sync Quill content to hidden textarea before form submission
document.querySelector('form').addEventListener('submit', function(e) {
    contentTextarea.value = quill.root.innerHTML;
});
</script>
{% endblock %}
